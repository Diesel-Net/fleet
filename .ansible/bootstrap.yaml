- hosts: all
  strategy: linear
  gather_facts: no
  vars:
    ansible_user: "{{ lookup('env', 'CLOUD_INIT_USERNAME') }}"
    ansible_ssh_pass: "{{ lookup('env','CLOUD_INIT_PASSWORD') }}"
    ansible_sudo_pass: "{{ ansible_ssh_pass }}"
  tasks:
    - wait_for_connection:
        timeout: 120

    - include_role:
        name: ubuntu
        tasks_from: configure

- hosts: swarm_manager
  strategy: linear
  tasks:
    - include_role:
        name: docker
        tasks_from: install

    - include_role:
        name: docker
        tasks_from: swarm_init


- hosts: nvidia
  strategy: linear
  tasks:
    - include_role:
        name: ubuntu
        tasks_from: install_nvidia_drivers

    - include_role:
        name: docker
        tasks_from: install_nvidia_toolkit

- hosts: traefik
  strategy: linear
  roles:
    - application
    - traefik

- hosts: fluentd
  strategy: linear
  roles:
    - application
    - fluentd

# - hosts: grafana-agent
#   strategy: linear
#   roles:
#     - application
#     - grafana-agent

