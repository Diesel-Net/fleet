- import_playbook: power_on.yaml
 
- hosts: manager:worker
  strategy: linear
  gather_facts: no
  vars:
    ansible_user: "{{ lookup('env', 'CLOUD_INIT_USER') }}"
    ansible_ssh_pass: "{{ lookup('env','CLOUD_INIT_PASS') }}"
    ansible_sudo_pass: "{{ ansible_ssh_pass }}"
  tasks:
    # this will hang (until timeout is reached) if host key changes (host key verification failure)
    # https://github.com/ansible/ansible/issues/58172
    # need to test with NEW hosts to see how this behaves
    - wait_for_connection:
        delay: 15
        timeout: 120

    - include_role:
        name: ubuntu
        tasks_from: setup_user


- hosts: manager:worker
  strategy: linear
  roles:
    - ubuntu
  tasks:
    - include_role:
        name: docker
        tasks_from: install

    - include_role:
        name: docker
        tasks_from: swarm_init


- hosts: nvidia
  strategy: linear
  tasks:
    - include_role:
        name: ubuntu
        tasks_from: install_nvidia_drivers

    - include_role:
        name: docker
        tasks_from: install_nvidia_toolkit


- import_playbook: power_off.yaml
